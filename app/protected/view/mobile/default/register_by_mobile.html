<!DOCTYPE HTML>
<html>
<head>
    <{include file='mobile/default/lib/meta.html'}>
    <title><{$GLOBALS.cfg.site_name}></title>
    <link rel="stylesheet" type="text/css" href="<{$common.theme}>/iconfont/iconfont.css">
    <link rel="stylesheet" type="text/css" href="<{$common.theme}>/css/general.css" />
    <link rel="stylesheet" type="text/css" href="<{$common.theme}>/css/login.css" />
    <script type="text/javascript" src="<{$common.theme}>/js/zepto.min.js"></script>
    <script type="text/javascript" src="<{$common.theme}>/js/verydows.mobile.js"></script>
</head>
<body>
<div class="wrapper">
    <div class="header">
        <div class="op lt"><a href="javascript:history.back(-1)"><i class="f20 iconfont">&#xe64c;</i></a></div>
        <h2><{$GLOBALS['cfg']['site_name']}></h2>
    </div>
    <{if $step == 1}>
    <script type="text/javascript">
        $(function () {
            var form = $('#rpform');
            form.find('input[name="mobile"]').bind('input propertychange', function() {
                var _this = $(this);
                if (_this.vdsFieldChecker({rules:{required:[true],mobile:[true]}}) === null) {
                    $('#nextStep').removeClass('disabled');
                } else if (!$('#nextStep').hasClass('disabled')) {
                    $('#nextStep').addClass('disabled');
                }
            });
        })
        
        function nextStep(e){
            if ($(e).hasClass('disabled')) {
                return;
            }
            var form = $('#rpform');
            form.find('input[name="mobile"]').vdsFieldChecker({rules:{required:[true, '请输入手机号'],mobile:[true, '请输入正确的手机号']}});
            form.find('input[name="captcha"]').vdsFieldChecker({rules:{required:[true, '请输入验证码']}});
            form.vdsFormChecker({isSubmit:true});
        }
    </script>
    <div class="login eform">
        <form id="rpform" method="post" action="<{url c='mobile/user' a='login' step='2'}>">
            <div class="user tr puff"><span class="icopos"><i class="iconfont">&#xe617;</i></span><input class="field variseclear" type="text" name="mobile" placeholder="请输入手机号" required /><i class="vinclrbtn iconfont">&#xe62d;</i></div>
        </form>
        <div class="bypass mt15 c999 cut f14">
            <div class="fl"><a href="<{url c='mobile/user' a='login_by_password'}>">用密码登录</a></div>
        </div>
        <div class="submit mt20"><a class="disabled" id="nextStep" onClick="nextStep(this)">登录/注册</a></div>
        <{if !empty($oauth_list)}>
        <div class="oauthli center mt30">
            <h3 class="c777 f14">使用社交账号登录/注册</h3>
            <div class="mt10">
                <{foreach $oauth_list as $v}>
                <a href="<{$v.url}>" id="<{$v.party}>"><img alt="<{$v.name}>" src="<{$common.baseurl}>/plugin/oauth/icon/<{$v.party}>.svg" /></a>
                <{/foreach}>
            </div>
        </div>
        <{/if}>
    </div>
    <{elseif $step == 2}>
    <script type="text/javascript">
        var countdown = 180;
        $(function(){
            $('#sendbtn').on('click', function(){sendCaptcha()});
        });

        function sendCaptcha(){
            $.asynInter("<{url c='api/sendmail' a='retrieve_password'}>", null, function(res){
                if(res.status == 'success'){
                    $('#sendbtn').off().removeClass('bluebtn').addClass('disbtn');
                    countdown = 180;
                    resendCounting();
                    $('#rpform').show();
                }else{
                    $.vdsPrompt({content:res.msg});
                }
            });
        }

        function resendCounting(){
            var timer = window.setInterval(function(){
                if(countdown >= 0){
                    $('#sendbtn').text(countdown+'秒后重新获取');
                    countdown --;
                }else{
                    clearInterval(timer);
                    $('#sendbtn').text('重新发送验证码到邮箱').removeClass('disbtn').addClass('bluebtn').on('click', function(){sendCaptcha()});
                    return false;
                }
            }, 1000);
        }

        function nextStep(){
            var form = $('#rpform');
            form.find('input[name="phone_captcha"]').vdsFieldChecker({rules:{required:[true, '请输入验证码']}});
            form.vdsFormChecker();
        }
    </script>
    <div class="retrieve cut">
        <h4 class="bsrow f14">
            <font class="c888">
                <{if $username != null }>
                    该手机已绑定用户名<{$username}>，验证码成功发送至该手机
                <{else}>
                    该手机尚未注册，请输入<{$mobile}>收到的验证码
                <{/if}>
             </font>
        </h4>
        <form id="rpform" method="post" action="<{url c='mobile/user' a='login' step='3'}>">
            <div class="split"></div>
            <div class="bsrow"><input class="center" type="text" name="phone_captcha" placeholder="短信验证码" /></div>
            <a class="redbtn bsbtn f14 xauto mt15" onClick="nextStep(this)"><{if $username != null}>登录<{else}>下一步<{/if}></a>
        </form>
    </div>
    <{elseif $step == 3}>
    <script type="text/javascript">
        //注册请求
        function register(){
            var form = $('.eform').eq(0).find('form');
            form.find('input[name="username"]').vdsFieldChecker({rules: {required:[true, '请设置用户名'],'minlen':[6, '用户名至少6位']}});
            form.find('input[name="password"]').vdsFieldChecker({rules: {required:[true, '请设置密码'], password:[true, '密码不符合要求，可包含字母、数字，长度至少为32']}});
            form.find('input[name="repassword"]').vdsFieldChecker({rules: {equal:[form.find('input[name="password"]').val(), '两次密码不一致']}});
            if(form.find('input[name="captcha"]').size() > 0){
                form.find('input[name="captcha"]').vdsFieldChecker({rules: {required:[true, '请输入验证码']}});
            }
            form.vdsFormChecker({isSubmit:true});
        }
        //登录请求
        function login(){
            var form = $('.eform').eq(1).find('form'), username = form.find('input[name="username"]'), password = form.find('input[name="password"]'), captcha = form.find('input[name="captcha"]');
            username.vdsFieldChecker({rules:{required:[true, '请输入用户名/邮箱']}});
            password.vdsFieldChecker({rules:{required:[true, '请输入密码']}});
            if(captcha.size() > 0){
                captcha.vdsFieldChecker({rules: {required:[true, '请输入验证码']}});
            }
            form.vdsFormChecker({isSubmit:true});
        }

        $(function(){
            $('.tabs a').on('click', function(){
                if(!$(this).hasClass('cur')){
                    var i = $(this).index();
                    $('.eform').hide().eq(i).show();
                    $('.tabs a.cur').removeClass('cur');
                    $(this).addClass('cur');
                }
            });
        });
    </script>
    <div class="oauth">
        <div class="tabs"><a class="cur">完善账号信息</a><a>绑定已有账号</a></div>
        <div class="form" >
            <div class="eform">
                <form method="post" id="reg" action="<{url c='mobile/user' a='login' step='4' type='reg'}>">
                    <div class="tr puff"><input class="field" type="text" name="username" id="username" placeholder="设置用户名（可包含字母、数字，至少6位）" /></div>
                    <div class="tr puff mt10"><input class="field" type="password" name="password" placeholder="设置登录密码" /><i class="vineyebtn iconfont">&#xe66e;</i></div>
                    <div class="tr puff mt10"><input class="field" type="password" name="repassword" placeholder="确认登录密码" /><i class="vineyebtn iconfont">&#xe66e;</i></div>
                    <{if !empty($GLOBALS.cfg.captcha_user_register)}>
                    <div class="captcha puff tr mt10" id="captcha">
                        <a class="fr"><img onclick="resetCaptcha(this)" src="<{url c='api/captcha' a='image'}>" /></a>
                        <input class="field" name="captcha" type="text" placeholder="请输入图形验证码" />
                    </div>
                    <{/if}>
                    <div class="submit mt20"><a href="javascript:void(0)" onClick="register(this)">完成注册</a></div>
                </form>
            </div>
            <div class="login eform hide">
                <form method="post" id="bind" action="<{url c='mobile/user' a='login' step='4' type='bind'}>">
                    <div class="user tr"><span class="icopos"><i class="iconfont">&#xe697;</i></span><input class="field variseclear" type="text" name="username" placeholder="请输入用户名/邮箱" required /><i class="vinclrbtn iconfont">&#xe62d;</i></div>
                    <div class="pwd tr"><span class="icopos"><i class="iconfont">&#xe607;</i></span><input class="field variseclear" type="password" name="password" placeholder="请输入密码" required /><i class="vinclrbtn iconfont">&#xe62d;</i><i class="vineyebtn iconfont">&#xe66e;</i></div>
                    <{if !empty($login_captcha)}>
                    <div class="captcha tr puff mt8" id="captcha">
                        <a class="fr"><img onclick="resetCaptcha(this)" src="<{url c='api/captcha' a='image'}>" /></a>
                        <span class="icopos"><i class="iconfont">&#xe601;</i></span><input class="field" name="captcha" type="text" placeholder="请输入图形验证码" />
                    </div>
                    <{/if}>
                    <div class="submit mt20"><a href="javascript:void(0)" onClick="login()">绑定并登录</a></div>
                </form>
            </div>
        </div>
    </div>
    <{/if}>
</div>
<{include file='mobile/default/lib/footer.html'}>
</body>
</html>