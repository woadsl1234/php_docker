<!DOCTYPE HTML>
<html>
<head>
<{include file='mobile/default/lib/meta.html'}>
<meta name="keywords" content="<{$goods.meta_keywords}>" />
<meta name="description" content="<{$goods.meta_description}>" />
<title><{$goods.goods_name}> - <{$GLOBALS.cfg.site_name}></title>
<link rel="stylesheet" type="text/css" href="<{$common.theme}>/css/general.css" />
<link rel="stylesheet" type="text/css" href="<{$common.theme}>/css/addpolicy.css">
<link rel="stylesheet" type="text/css" href="<{$common.theme}>/iconfont/iconfont.css">
<link rel="stylesheet" type="text/css" href="<{$common.theme}>/css/goods.css" />
  <style>
    .pre-sell-label {
      padding: 5px 10px;
      background-color: rgba(255,247,204,.95);
      color: #f60;
      text-align: center;
    }
  </style>
<script type="text/javascript" src="<{$common.theme}>/js/zepto.min.js"></script>
<script type="text/javascript" src="<{$common.theme}>/js/verydows.mobile.js"></script>
<script type="text/javascript" src="<{$common.theme}>/js/goods.js"></script>
<script type="text/javascript" src="<{$common.theme}>/js/jweixin.js"></script>
<script type="text/javascript">
$(function(){
  viewCartbar();
  preserveSpace('footfixed');
  $('#showMenuBtn').vdsTapSwapper(
    function(){$('#topMenu').height(50);},
    function(){$('#topMenu').height(0);}
  );
  albumSlider();

  //如果库存为0则将购买和加入购物车置为灰色，并修改文字
  var left = parseInt($(".stock .pink").text());
  if(left>0){
    $('.buy').on('click',function () {
      toBuy("<{$goods.goods_id}>", "<{url c='mobile/cart' a='index'}>");
    });
    $('#addcartbtn').on('click',function () {
      addToCart('<{$goods.goods_id}>');
    });
  }else{
    $('.buy').text("库存不足").css({'color':'#AAA','background':'#e2dede'});
    $('#addcartbtn').css({'color':'#AAA','background':'#e5e5e5'});
  }
});

function addFavorite(goods_id){
  $.asynInter("<{url c='api/favorite' a='add'}>", {goods_id:goods_id}, function(res){
    if(res.status == 'success'){
      $.vdsPrompt({content:'加入收藏夹成功!'});
    }else if(res.status == 'unlogined'){
      $.vdsPrompt({
        content:res.msg,
        clicked:function(){
          window.location.href = "<{url c='mobile/user' a='login'}>";
        }
      });
    }
    else{
      $.vdsPrompt({content:res.msg});
    }
  });
}
</script>

  <style>
    .lateral .th h2 font{
      font-size: 10px;
    }
    .pri {
      display: inline-block;
    }
    .sales_volume {
      display: inline-block;
      float: right;
      color: #93a0ae;
      margin-top: 12px;
    }
  </style>
</head>
<body>
<div class="wrapper" id="wrapper">
  <!-- header start -->
  <div class="header">
    <div class="op lt"><a href="javascript:history.back(-1);"><i class="f20 iconfont">&#xe602;</i></a></div>
    <h2>商品详情</h2>
    <div class="op rt"><a class="pointer" id="showMenuBtn"><i class="f28 iconfont">&#xe60e;</i></a></div>
  </div>
  <!-- header end -->
  <div class="absmu latent" id="topMenu">
    <a href="<{url c='mobile/main' a='index'}>"><i class="home iconfont">&#xe606;</i><span>首页</span></a>
    <a href="<{url c='mobile/cart' a='index'}>"><i class="home iconfont">&#xe6af;</i><span>购物车</span></a>
    <a href="<{url c='mobile/order' a='list'}>"><i class="home iconfont">&#xe683;</i><span>订单</span></a>
    <a href="<{url c='mobile/user' a='index'}>"><i class="home iconfont">&#xe632;</i><span>我的</span></a>
  </div>
  <{if $goods.pre_sell > 0}>
  <p class="pre-sell-label">
    温馨提示：该商品暂无现货，你可提前下单预定<br>下单日起2~4天送达，最迟不超过7天
  </p>
  <{/if}>
  <!-- goods imgs start -->
  <div class="gims" id="gims">
    <div class="slider">
      <a><img src="<{$GLOBALS['cfg']['image_host'].$goods.goods_image.$GLOBALS['cfg']['image_style']['large']}>" /></a>
      <{if !empty($album_list)}>
      <{foreach $album_list as $v}>
      <a><img src="<{$common.baseurl}>/upload/goods/album/0/<{$v.image}>"></a>
      <{/foreach}>
      <{/if}>
    </div>
    <div class="clearfix"></div>
    <div class="trigger"><b>1</b><span>/</span><font>1</font></div>
  </div>
  <!-- goods imgs end -->
  <div class="gth">
    <p class="goods_name"><{$goods.goods_name}></p>
    <h3 class="mt8 c888"><{if trim($goods.goods_sn) != ''}>货号：<{$goods.goods_sn}> <{/if}> <{$goods.goods_brief nofilter}></h3>
    <div class="pri mt8">
      <span class="cny"><i>¥</i><font id="nowprice" data-price="<{$goods.now_price}>"><{$goods.now_price}></font></span>
      <{if $goods.original_price > 0}><span class="ori cny mr10">¥<{$goods.original_price}></span><{/if}>
    </div>
    <{if $sales_volume > 0}>
      <div class="sales_volume mt8">销量：<{$sales_volume}></div>
    <{/if}>
  </div>
  <div class="gopts mt10" id="buyopts">
    <{if !empty($opt_list)}>
    <{foreach $opt_list as $v}>
    <dl class="ck">
      <dt data-name="<{$v.type_name}>"><{$v.type_name}>：</dt>
      <dd>
        <{foreach $v.children as $vv}>
        <a data-key="<{$vv.id}>" data-price="<{$vv.opt_price}>"><{$vv.opt_text}></a>
        <{/foreach}>
      </dd>
    </dl>
    <{/foreach}>
    <{/if}>

    <dl class="qty">
      <dt>购买数量：</dt>
      <dd>
        <a class="minus" onclick="changeBuyQty('decr')">-</a><input id="buy-qty" type="text" readonly value="1" data-stock='<{$goods.stock_qty}>' /><a class="plus" onclick="changeBuyQty('incr')">+</a>
        <{if($GLOBALS.cfg.show_goods_stock)}>
        <span class="stock">剩余<b class="pink"><{$goods.stock_qty}></b>件</span>
        <{/if}>
      </dd>
    </dl>
  </div>

  <div class="gdata mt10 cut">
    <a href="<{url c='mobile/goods' a='reviews' id=$goods.goods_id}>">
      <span class="fl"><font class="f14">商品评价</font><font class="total ml5">(<{$review_rating.total}>)</font></span>
      <i class="fr iconfont">&#xe614;</i>
      <{if $review_rating.total > 0}><span class="hint fr">满意度<{$review_rating.satis}>%</span><{/if}>
    </a>
    <div class="detail-title">商品详情</div>
    <div class="detail">
      <div class="mt5"><{$goods.goods_content nofilter}></div>
    </div>

  </div>
  <{if !empty($related)}>
  <div class="lateral mt10">
    <div class="th"><h2><i class="icon"></i><font>你可能还想买</font></h2></div>
    <div class="gli">
      <div class="slider">
        <div class="col">
            <{foreach $related as $v}>
            <div class="goods_card">
              <a href="<{url c='mobile/goods' a='index' id=$v.goods_id}>">
                <div class="img-container">
                  <img src="<{$GLOBALS['cfg']['image_host'].$v.goods_image.$GLOBALS['cfg']['image_style']['middle']}>">
                </div>
                <div class="name"><{truncate($v.goods_name, 40)}></div>
                <div class="price"><span class="sell-price">¥<{$v.now_price}><del class="original-price">¥<{$v.original_price}></del></span></div>
              </a>
            </div>
            <{/foreach}>
        </div>
      </div>
      <div class="clearfix"></div>
    </div>
  </div>
  <{/if}>
</div>
<div class="footact" id="footfixed">
  <div class="iact fl cut">
    <a href="javascript:void(0)" onclick="addFavorite('<{$goods.goods_id}>')"><i class="iconfont">&#xe605;</i><span>收藏</span></a>
    <a id="cartbar" href="<{url c='mobile/cart' a='index'}>"><i class="iconfont">&#xe603;</i><span>购物车</span><em class="hide">0</em></a>
  </div>
  <div class="bact cut"><a class="add" id="addcartbtn">加入购物车</a><a class="buy"><{if $goods.pre_sell > 0}>提前预定<{else}>立即购买<{/if}></a></div>
</div>
<{include file='mobile/default/lib/footer.html'}>
</body>
<script>
    var lurl = (location.href.split('#')[0]).toString();
    $.ajax({
        type: 'get',
        url: 'https://api.tiaozaoj.com/we_chat/js_api',
        data: {"url":lurl},
        dataType: 'json',
        sync:true,
        success: function(data){
            if(data.errNum === 0){
                var config = data.retData;
                wx.config({
                    debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                    appId: config.appId, // 必填，公众号的唯一标识
                    timestamp: config.timestamp, // 必填，生成签名的时间戳
                    nonceStr: config.nonceStr, // 必填，生成签名的随机串
                    signature: config.signature,// 必填，签名，见附录1
                    jsApiList : [
                        // 所有要调用的 API 都要加到这个列表中
                        'onMenuShareTimeline',       // 分享到朋友圈接口
                        'onMenuShareAppMessage',  //  分享到朋友接口
                        'onMenuShareQQ',         // 分享到QQ接口
                        'onMenuShareQZone'//分享到空间
                    ]
                });
            }
        },
        error: function(data){
        }
    });

    wx.ready(function() {
        // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
        var share_data = {
            title: "<{$goods.goods_name}> - <{$GLOBALS.cfg.site_name}>", // 分享标题
            desc: "<{strip_tags($goods.goods_brief)}>", // 分享描述
            link: location.href, // 分享链接
            imgUrl: "<{$GLOBALS['cfg']['image_host'].$goods.goods_image.$GLOBALS['cfg']['image_style']['small']}>", // 分享图标
            success: function () {
                // 用户确认分享后执行的回调函数
            },
            cancel: function () {
                // 用户取消分享后执行的回调函数
            }
        };
        wx.onMenuShareAppMessage(share_data);
        wx.onMenuShareQQ(share_data);
        wx.onMenuShareTimeline(share_data);
        wx.onMenuShareQZone(share_data);
    });
</script>
</html>